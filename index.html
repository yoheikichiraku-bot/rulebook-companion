<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ãƒ»ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f1117;--bg2:#1a1d27;--bg3:#242834;--surface:#2a2e3a;--border:#363b4a;--text:#e4e6ed;--text2:#9499a8;--accent:#f0a050;--accent2:#e8784e;--accent-glow:rgba(240,160,80,.12);--green:#5ec490;--blue:#5b9cf0;--red:#e85858}
body{font-family:'Zen Kaku Gothic New','Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.hidden{display:none!important}

.header{background:linear-gradient(135deg,var(--bg2),#1e2230);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100;backdrop-filter:blur(10px)}
.header-icon{font-size:26px;filter:drop-shadow(0 0 10px rgba(240,160,80,.4))}
.header h1{font-size:17px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-sub{font-size:10px;color:var(--text2)}
.header-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.file-badge{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:3px 10px;font-size:11px;color:var(--text2);display:flex;align-items:center;gap:5px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-badge .dot{width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0}
.hdr-btn{width:34px;height:34px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s}
.hdr-btn:hover{border-color:var(--accent);background:var(--accent-glow)}

.upload-zone{margin:40px auto;max-width:520px;border:2px dashed var(--border);border-radius:16px;padding:56px 28px;text-align:center;cursor:pointer;transition:.3s;background:var(--bg2)}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--accent);background:var(--accent-glow);transform:translateY(-2px)}
.upload-icon{font-size:44px;margin-bottom:14px}
.upload-main{font-size:16px;font-weight:500;margin-bottom:6px}
.upload-sub{font-size:13px;color:var(--text2)}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 10px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Tabs - scrollable */
.tabs{display:flex;gap:2px;max-width:960px;margin:0 auto;padding:0 16px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.tabs::-webkit-scrollbar{height:0}
.tab-btn{padding:9px 12px;border:none;background:var(--bg2);color:var(--text2);font-family:inherit;font-size:12px;font-weight:500;cursor:pointer;border-radius:8px 8px 0 0;transition:.2s;border:1px solid transparent;border-bottom:none;white-space:nowrap;flex-shrink:0}
.tab-btn:hover{color:var(--text);background:var(--bg3)}
.tab-btn.active{background:var(--surface);color:var(--accent);border-color:var(--border)}
.main-area{max-width:960px;margin:0 auto;padding:0 16px 90px}
.content-area{background:var(--surface);border:1px solid var(--border);border-radius:0 0 14px 14px;padding:18px;min-height:400px}

.tts-error{background:rgba(232,88,88,.15);border:1px solid var(--red);border-radius:10px;padding:10px 14px;margin-bottom:14px;font-size:13px;color:var(--red);display:flex;align-items:center;gap:8px}
.tts-error button{margin-left:auto;background:none;border:none;color:var(--red);cursor:pointer;font-size:16px}

.btn{padding:8px 16px;border-radius:9px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-family:inherit;font-size:12px;font-weight:500;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{border-color:var(--accent);background:var(--accent-glow)}
.btn:disabled{opacity:.4;cursor:not-allowed}
.btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border-color:transparent;font-weight:600}
.btn.primary:hover{opacity:.9}
.icon-btn{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s}
.icon-btn:hover{border-color:var(--accent);background:var(--accent-glow)}

/* Card */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;margin-bottom:10px;overflow:hidden}
.card.accent{border-color:rgba(240,160,80,.2)}
.card-head{padding:11px 14px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);background:rgba(255,255,255,.02)}
.card-head h3{font-size:13px;font-weight:600}
.card-body{padding:14px;font-size:13px;line-height:1.8;white-space:pre-wrap}
.placeholder{font-size:12px;color:var(--text2);font-style:italic}
.dot-anim span{display:inline-block;width:5px;height:5px;border-radius:50%;background:currentColor;animation:dotpulse 1.2s ease-in-out infinite}.dot-anim span:nth-child(2){animation-delay:.2s}.dot-anim span:nth-child(3){animation-delay:.4s}
@keyframes dotpulse{0%,100%{opacity:.3}50%{opacity:1}}

/* Reader */
.reader-controls{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.reader-controls .spacer{flex:1}
.reader-hint{font-size:11px;color:var(--text2);margin-bottom:10px;padding:7px 12px;background:var(--bg2);border-radius:8px;border:1px solid var(--border)}
.fulltext{font-size:13px;line-height:2;color:var(--text2);padding-left:30px;position:relative}
.para{padding:5px 10px;margin:2px -10px;border-radius:6px;cursor:pointer;transition:all .2s;border-left:3px solid transparent;position:relative}
.para:hover{background:rgba(255,255,255,.03);border-left-color:rgba(240,160,80,.3)}
.para.done{opacity:.4}
.para.playing{background:rgba(240,160,80,.1);border-left-color:var(--accent);color:var(--text);opacity:1}
.para.playing::before{content:'ğŸ”Š';position:absolute;left:-28px;top:7px;font-size:12px}
.para.generating{background:rgba(91,156,240,.08);border-left-color:var(--blue);color:var(--text);opacity:1}
.para.generating::before{content:'â³';position:absolute;left:-28px;top:7px;font-size:12px;animation:pulse-icon 1s infinite}
@keyframes pulse-icon{0%,100%{opacity:.4}50%{opacity:1}}
.para.toc-para{opacity:.3;font-size:12px;line-height:1.6;border-left-color:var(--border)}
.para.toc-para:hover{opacity:.5}
.toc-label{display:flex;align-items:center;gap:8px;margin:8px -10px;padding:4px 12px;font-size:11px;color:var(--text2);background:var(--bg2);border-radius:6px;border:1px dashed var(--border)}
.toc-label button{background:none;border:none;color:var(--accent);font-size:11px;font-family:inherit;cursor:pointer;text-decoration:underline;padding:0}
.page-divider{display:flex;align-items:center;gap:10px;margin:18px -10px 8px;padding:0 10px}
.page-divider:first-child{margin-top:0}
.page-divider-line{flex:1;height:1px;background:var(--border)}
.page-divider-label{font-size:10px;font-weight:600;color:var(--text2);white-space:nowrap;padding:2px 8px;background:var(--bg3);border-radius:10px}
.sec-divider{display:flex;align-items:center;gap:10px;margin:16px -10px 6px;padding:0 10px}
.sec-divider-line{flex:1;height:1px;background:linear-gradient(90deg,var(--accent),transparent)}
.sec-divider-label{font-size:11px;font-weight:600;color:var(--accent);white-space:nowrap;max-width:70%;overflow:hidden;text-overflow:ellipsis}
.sec-divider-line.right{background:linear-gradient(90deg,transparent,var(--accent))}
.sec-play-btn{background:none;border:1px solid rgba(240,160,80,.3);color:var(--accent);border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.sec-play-btn:hover{background:rgba(240,160,80,.15);border-color:var(--accent)}
.sec-colors{--sc0:#f0a050;--sc1:#50b0f0;--sc2:#80d080;--sc3:#e080c0;--sc4:#c0a0f0;--sc5:#f0d060;--sc6:#60d0d0;--sc7:#f08060}
.sec-nav{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:10px}
.sec-nav-btn{padding:3px 8px;border-radius:5px;border:1px solid var(--border);background:var(--bg2);color:var(--text2);font-family:inherit;font-size:10px;cursor:pointer;transition:.2s;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sec-nav-btn:hover{border-color:var(--accent);color:var(--accent)}

/* Playback bar */
.playback-bar{position:fixed;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid var(--border);padding:8px 16px;z-index:100;display:flex;justify-content:center}
.playback-inner{max-width:960px;width:100%;display:flex;align-items:center;gap:8px}
.pb-controls{display:flex;gap:3px;align-items:center;flex-shrink:0}
.pb-btn{width:34px;height:34px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:.2s;background:var(--surface);color:var(--text);border:1px solid var(--border)}
.pb-btn:hover{border-color:var(--accent)}
.pb-main{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;width:40px;height:40px;font-size:18px;border:none}
.pb-main:hover{filter:brightness(1.1)}
.pb-skip{font-size:9px;font-weight:700;width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s;flex-shrink:0}
.pb-skip:hover{border-color:var(--accent);color:var(--accent)}
.pb-info{flex:1;min-width:0}
.pb-title{font-size:11px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pb-sub{font-size:10px;color:var(--text2);margin-top:1px}
.pb-progress{width:100%;height:4px;background:var(--bg);border-radius:2px;margin-top:3px;overflow:hidden;cursor:pointer}
.pb-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:2px;transition:width .3s;width:0}
.pb-time{font-size:10px;color:var(--text2);min-width:40px;text-align:right;flex-shrink:0}

/* Glossary */
.glossary-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
.glossary-item:last-child{border:none}
.glossary-term{font-weight:600;font-size:13px;color:var(--accent);min-width:100px;flex-shrink:0}
.glossary-def{font-size:12.5px;line-height:1.7;color:var(--text)}

/* Flow chart */
.flow-container{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;min-height:200px;overflow-x:auto}

/* Scenario */
.scenario-input{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
.scenario-chip{padding:6px 14px;border-radius:18px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-family:inherit;font-size:12px;cursor:pointer;transition:.2s}
.scenario-chip:hover{border-color:var(--accent);color:var(--text)}
.scenario-chip.active{border-color:var(--accent);background:var(--accent-glow);color:var(--accent)}

/* QA */
.qa-panel{display:flex;flex-direction:column;height:440px}
.qa-header{margin-bottom:10px}.qa-header h3{font-size:15px;margin-bottom:3px}.qa-header p{font-size:11px;color:var(--text2)}
.qa-messages{flex:1;overflow-y:auto;padding:8px 0;display:flex;flex-direction:column;gap:7px}
.qa-messages::-webkit-scrollbar{width:4px}.qa-messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.qa-empty{text-align:center;padding:32px 0;color:var(--text2)}
.qa-examples{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin-top:12px}
.qa-examples button{padding:5px 11px;border-radius:18px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-family:inherit;font-size:11px;cursor:pointer;transition:.2s}
.qa-examples button:hover{border-color:var(--accent);color:var(--text)}
.qa-msg{display:flex}.qa-msg.user{justify-content:flex-end}
.qa-msg-bubble{max-width:80%;padding:8px 12px;border-radius:12px;font-size:12px;line-height:1.7;white-space:pre-wrap}
.qa-msg.user .qa-msg-bubble{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border-bottom-right-radius:4px}
.qa-msg.assistant .qa-msg-bubble{background:var(--bg3);color:var(--text);border-bottom-left-radius:4px}
.qa-input-row{display:flex;gap:6px;margin-top:8px}
.qa-input-row input{flex:1;padding:9px 13px;border-radius:10px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-family:inherit;font-size:12px;outline:none}
.qa-input-row input:focus{border-color:var(--accent)}
.qa-input-row input::placeholder{color:var(--text2)}
.qa-input-row button{padding:9px 16px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer}
.qa-input-row button:disabled{opacity:.4;cursor:not-allowed}

/* Raw text */
.raw-text{font-size:12px;line-height:1.8;color:var(--text2);white-space:pre-wrap;word-break:break-word;max-height:600px;overflow-y:auto;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px}

/* Settings */
.settings-group{margin-bottom:18px}
.settings-group>label{display:block;font-size:12px;font-weight:600;margin-bottom:4px}
.settings-hint{font-size:10px;color:var(--text2);margin-bottom:6px}
.settings-input{width:100%;padding:8px 11px;border-radius:9px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-family:inherit;font-size:12px;outline:none}
.settings-input:focus{border-color:var(--accent)}
.key-input-row{display:flex;gap:6px}.key-input-row .settings-input{flex:1}
.key-status{margin-top:5px;font-size:10px;padding:4px 8px;border-radius:5px;background:rgba(94,196,144,.1);color:var(--green)}
.api-keys-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.voice-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-top:5px}
.voice-chip{padding:7px 8px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);cursor:pointer;transition:.2s;text-align:center;font-family:inherit}
.voice-chip:hover{border-color:var(--accent)}.voice-chip.active{border-color:var(--accent);background:var(--accent-glow)}
.voice-name{display:block;font-size:12px;font-weight:600;color:var(--text)}
.voice-desc{display:block;font-size:9px;color:var(--text2);margin-top:1px}
.speed-row{display:flex;align-items:center;gap:6px;margin-top:5px;font-size:10px;color:var(--text2)}
.speed-row input[type="range"]{flex:1;accent-color:var(--accent)}
/* TTS engine selector */
.engine-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:5px}
.engine-chip{padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);cursor:pointer;transition:.2s;font-family:inherit}
.engine-chip:hover{border-color:var(--accent)}.engine-chip.active{border-color:var(--accent);background:var(--accent-glow)}
.engine-name{font-size:12px;font-weight:600;color:var(--text)}
.engine-desc{font-size:10px;color:var(--text2);margin-top:2px}
.engine-tag{display:inline-block;font-size:9px;padding:1px 6px;border-radius:4px;margin-left:4px;font-weight:600}
.tag-free{background:rgba(94,196,144,.15);color:var(--green)}
.tag-quality{background:rgba(240,160,80,.15);color:var(--accent)}

@media(max-width:640px){
  .header{padding:10px 12px}.header h1{font-size:15px}
  .main-area{padding:0 8px 90px}.content-area{padding:12px}
  .tab-btn{font-size:11px;padding:8px 8px}
  .file-badge{display:none}.voice-grid{grid-template-columns:1fr 1fr}
  .api-keys-row{grid-template-columns:1fr}.engine-grid{grid-template-columns:1fr}
  .fulltext{padding-left:22px}.para::before{left:-20px;font-size:11px}
  /* Larger touch targets on mobile */
  .para{padding:10px;min-height:44px}
  .pb-main{width:48px;height:48px;font-size:22px}
  .pb-skip{width:34px;height:34px;font-size:11px}
  .pb-btn{width:38px;height:38px}
  .sec-nav-btn{padding:6px 10px;font-size:11px}
}
/* iOS-specific */
button,input{-webkit-tap-highlight-color:transparent}
input{-webkit-appearance:none;border-radius:9px}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-icon">ğŸ“–</div>
  <div><h1>ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ãƒ»ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³</h1><div class="header-sub">æœ—èª­ ãƒ» AIè¦ç´„ ãƒ» ç”¨èªé›† ãƒ» ãƒ•ãƒ­ãƒ¼å›³ ãƒ» ã‚·ãƒŠãƒªã‚ª ãƒ» Q&A</div></div>
  <div class="header-right">
    <div id="fileBadge" class="file-badge hidden"><span class="dot"></span><span id="fileNameBadge"></span></div>
    <button class="hdr-btn" onclick="resetApp()" id="resetBtn" style="display:none" title="åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«">ğŸ”„</button>
  </div>
</div>

<!-- Upload -->
<div id="uploadScreen">
  <div class="upload-zone" id="uploadZone">
    <input type="file" id="fileInput" accept=".pdf,image/*" multiple hidden>
    <div id="uploadContent"><div class="upload-icon">ğŸ“–</div><p class="upload-main">ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p><p class="upload-sub">PDF or ç”»åƒï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸OKï¼‰ã‚’ãƒ‰ãƒ­ãƒƒãƒ— / ã‚¯ãƒªãƒƒã‚¯</p><p style="font-size:11px;color:var(--text2);margin-top:4px">ğŸ“· ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚„å†™çœŸã‚‚OKï¼ˆClaude Visionä½¿ç”¨ï¼‰</p></div>
    <div id="uploadLoading" class="hidden"><div class="spinner"></div><p id="uploadStatus">èª­ã¿è¾¼ã¿ä¸­...</p></div>
  </div>
  <div id="setupHint" style="text-align:center;margin-top:-12px;margin-bottom:16px"><button class="btn" onclick="switchTab('settings')">âš™ï¸ ã¾ãšAPIã‚­ãƒ¼ã‚’è¨­å®š</button></div>
</div>

<!-- App -->
<div id="appScreen" class="hidden">
  <div class="main-area">
    <div class="tabs" id="tabBar">
      <button class="tab-btn active" data-tab="reader" onclick="switchTab('reader')">ğŸ“– æœ—èª­</button>
      <button class="tab-btn" data-tab="summary" onclick="switchTab('summary')">ğŸ“‹ è¦ç´„</button>
      <button class="tab-btn" data-tab="glossary" onclick="switchTab('glossary')">ğŸ“– ç”¨èªé›†</button>
      <button class="tab-btn" data-tab="flow" onclick="switchTab('flow')">ğŸ”„ ãƒ•ãƒ­ãƒ¼</button>
      <button class="tab-btn" data-tab="scenario" onclick="switchTab('scenario')">ğŸ² ã‚·ãƒŠãƒªã‚ª</button>
      <button class="tab-btn" data-tab="qa" onclick="switchTab('qa')">ğŸ’¬ Q&A</button>
      <button class="tab-btn" data-tab="raw" onclick="switchTab('raw')">ğŸ“„ åŸæ–‡</button>
      <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</button>
    </div>
    <div class="content-area">
      <div id="ttsError" class="tts-error hidden"><span id="ttsErrorMsg"></span><button onclick="$('ttsError').classList.add('hidden')">âœ•</button></div>

      <!-- READER -->
      <div id="tab-reader">
        <div class="reader-controls">
          <button class="btn primary" id="playAllBtn" onclick="togglePlay()">â–¶ æœ€åˆã‹ã‚‰å†ç”Ÿ</button>
          <button class="btn" id="tocBtn" onclick="detectSections()">ğŸ“‘ ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Š</button>
          <button class="btn hidden" id="translateBtn" onclick="translateAll()">ğŸŒ ç¿»è¨³</button>
          <span class="spacer"></span>
          <span id="statusText" style="font-size:11px;color:var(--text2)"></span>
        </div>
        <div class="reader-hint">ğŸ’¡ æ®µè½ã‚¯ãƒªãƒƒã‚¯ â†’ æœ—èª­é–‹å§‹ã€‚å†ç”Ÿä¸­ã«åˆ¥ã®æ®µè½ã‚¯ãƒªãƒƒã‚¯ â†’ ã‚¸ãƒ£ãƒ³ãƒ—</div>
        <div id="secNav" class="sec-nav hidden"></div>
        <div id="fulltext" class="fulltext sec-colors"></div>
      </div>

      <!-- SUMMARY -->
      <div id="tab-summary" class="hidden">
        <div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn primary" id="analyzeAllBtn" onclick="analyzeAll()">âœ¨ å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³è§£æ</button></div>
        <div id="sectionsContainer"></div>
      </div>

      <!-- GLOSSARY -->
      <div id="tab-glossary" class="hidden">
        <div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn primary" id="glossaryBtn" onclick="generateGlossary()">ğŸ“– ç”¨èªã‚’æŠ½å‡º</button></div>
        <div id="glossaryContent"><div class="placeholder">ã€Œç”¨èªã‚’æŠ½å‡ºã€ã‚’æŠ¼ã™ã¨ã€ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯å†…ã®å°‚é–€ç”¨èªã‚’AIãŒè‡ªå‹•æŠ½å‡ºãƒ»è§£èª¬ã—ã¾ã™</div></div>
      </div>

      <!-- FLOW -->
      <div id="tab-flow" class="hidden">
        <div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn primary" id="flowBtn" onclick="generateFlow()">ğŸ”„ ãƒ•ãƒ­ãƒ¼å›³ã‚’ç”Ÿæˆ</button></div>
        <div id="flowContent"><div class="placeholder">ã€Œãƒ•ãƒ­ãƒ¼å›³ã‚’ç”Ÿæˆã€ã‚’æŠ¼ã™ã¨ã€ã‚¿ãƒ¼ãƒ³ã®æµã‚Œã‚’ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã§å¯è¦–åŒ–ã—ã¾ã™</div></div>
      </div>

      <!-- SCENARIO -->
      <div id="tab-scenario" class="hidden">
        <div style="margin-bottom:10px"><p style="font-size:13px;font-weight:500;margin-bottom:8px">ãƒ—ãƒ¬ã‚¤æ¡ä»¶ã‚’é¸æŠ:</p>
          <div class="scenario-input" id="scenarioPlayers">
            <button class="scenario-chip active" onclick="selectChip(this,'scenarioPlayers')">2äºº</button>
            <button class="scenario-chip" onclick="selectChip(this,'scenarioPlayers')">3äºº</button>
            <button class="scenario-chip" onclick="selectChip(this,'scenarioPlayers')">4äºº</button>
            <button class="scenario-chip" onclick="selectChip(this,'scenarioPlayers')">5äººä»¥ä¸Š</button>
          </div>
          <div class="scenario-input" id="scenarioLevel">
            <button class="scenario-chip active" onclick="selectChip(this,'scenarioLevel')">åˆãƒ—ãƒ¬ã‚¤</button>
            <button class="scenario-chip" onclick="selectChip(this,'scenarioLevel')">2å›ç›®</button>
            <button class="scenario-chip" onclick="selectChip(this,'scenarioLevel')">çµŒé¨“è€…</button>
          </div>
          <button class="btn primary" id="scenarioBtn" onclick="generateScenario()">ğŸ² ã‚·ãƒŠãƒªã‚ªç”Ÿæˆ</button>
        </div>
        <div id="scenarioContent"><div class="placeholder">æ¡ä»¶ã‚’é¸ã‚“ã§ã€Œã‚·ãƒŠãƒªã‚ªç”Ÿæˆã€ã‚’æŠ¼ã™ã¨ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¾‹ã‚„æ¨å¥¨æˆ¦ç•¥ã‚’AIãŒææ¡ˆã—ã¾ã™</div></div>
      </div>

      <!-- QA -->
      <div id="tab-qa" class="hidden">
        <div class="qa-panel">
          <div class="qa-header"><h3>ğŸ’¬ ãƒ«ãƒ¼ãƒ«Q&A</h3><p>ãƒ—ãƒ¬ã‚¤ä¸­ã®ç–‘å•ã‚’AIã«è³ªå•</p></div>
          <div class="qa-messages" id="qaMessages">
            <div class="qa-empty" id="qaEmpty"><p>ãƒ«ãƒ¼ãƒ«ã«ã¤ã„ã¦ä½•ã§ã‚‚èã„ã¦ãã ã•ã„</p>
              <div class="qa-examples">
                <button onclick="$('qaInput').value='ã‚¿ãƒ¼ãƒ³ã®æœ€åˆã«ä½•ã‚’ã™ã‚‹ï¼Ÿ'">ã‚¿ãƒ¼ãƒ³ã®æœ€åˆã«ä½•ã‚’ã™ã‚‹ï¼Ÿ</button>
                <button onclick="$('qaInput').value='å‹åˆ©æ¡ä»¶ã‚’æ•™ãˆã¦'">å‹åˆ©æ¡ä»¶ã‚’æ•™ãˆã¦</button>
                <button onclick="$('qaInput').value='ã“ã®ã‚²ãƒ¼ãƒ ã§ã‚ˆãã‚ã‚‹ãƒŸã‚¹ã¯ï¼Ÿ'">ã‚ˆãã‚ã‚‹ãƒŸã‚¹ã¯ï¼Ÿ</button>
              </div>
            </div>
          </div>
          <div class="qa-input-row"><input id="qaInput" placeholder="ãƒ«ãƒ¼ãƒ«ã«ã¤ã„ã¦è³ªå•..." onkeydown="if(event.key==='Enter')askQA()"><button id="qaSubmit" onclick="askQA()">é€ä¿¡</button></div>
        </div>
      </div>

      <!-- RAW TEXT -->
      <div id="tab-raw" class="hidden">
        <div class="raw-text" id="rawText"></div>
      </div>

      <!-- SETTINGS -->
      <div id="tab-settings" class="hidden">
        <h3 style="font-size:15px;margin-bottom:14px">âš™ï¸ è¨­å®š</h3>
        <div class="api-keys-row">
          <div class="settings-group">
            <label>OpenAI APIã‚­ãƒ¼</label><p class="settings-hint">OpenAI TTSéŸ³å£°ã«å¿…è¦</p>
            <div class="key-input-row"><input type="password" id="openaiKeyInput" placeholder="sk-..." class="settings-input"><button class="icon-btn" onclick="toggleVis('openaiKeyInput',this)">ğŸ‘</button></div>
            <button class="btn primary" style="margin-top:5px;width:100%" onclick="saveKey('openai')">ä¿å­˜</button>
            <div id="openaiKeyStatus" class="key-status hidden">âœ“ è¨­å®šæ¸ˆã¿</div>
          </div>
          <div class="settings-group">
            <label>Anthropic APIã‚­ãƒ¼</label><p class="settings-hint">AIè¦ç´„ãƒ»Q&Aãƒ»ç”¨èªé›†ç­‰ã«å¿…è¦</p>
            <div class="key-input-row"><input type="password" id="claudeKeyInput" placeholder="sk-ant-..." class="settings-input"><button class="icon-btn" onclick="toggleVis('claudeKeyInput',this)">ğŸ‘</button></div>
            <button class="btn primary" style="margin-top:5px;width:100%" onclick="saveKey('claude')">ä¿å­˜</button>
            <div id="claudeKeyStatus" class="key-status hidden">âœ“ è¨­å®šæ¸ˆã¿</div>
          </div>
        </div>
        <div class="settings-group">
          <label>éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³</label>
          <div class="engine-grid" id="engineGrid"></div>
        </div>
        <div id="openaiVoiceSettings">
          <div class="settings-group">
            <label>OpenAI éŸ³å£°</label>
            <div class="voice-grid" id="voiceGrid"></div>
          </div>
        </div>
        <div class="settings-group">
          <label>é€Ÿåº¦: <span id="speedLabel">1.00x</span></label>
          <div class="speed-row"><span>ğŸ¢</span><input type="range" min="0.5" max="2.0" step="0.05" value="1.0" id="speedSlider" oninput="S.ttsSpeed=+this.value;$('speedLabel').textContent=S.ttsSpeed.toFixed(2)+'x';localStorage.setItem('ttsSpeed',S.ttsSpeed)"><span>ğŸ‡</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Playback Bar -->
<div class="playback-bar hidden" id="playbackBar">
  <div class="playback-inner">
    <div class="pb-controls">
      <button class="pb-skip" onclick="skipTime(-10)">-10</button>
      <button class="pb-btn pb-main" id="pbPlayBtn" onclick="togglePlay()">â–¶</button>
      <button class="pb-skip" onclick="skipTime(10)">+10</button>
    </div>
    <div class="pb-info">
      <div class="pb-title" id="pbTitle">æ®µè½ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†ç”Ÿ</div>
      <div class="pb-sub" id="pbSub"></div>
      <div class="pb-progress" onclick="seekAudio(event)"><div class="pb-progress-fill" id="pbFill"></div></div>
    </div>
    <div class="pb-time" id="pbTime"></div>
    <button class="pb-btn" onclick="stopAndReset()" title="åœæ­¢" style="font-size:12px">â¹</button>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
const $=id=>document.getElementById(id);
const TABS=['reader','summary','glossary','flow','scenario','qa','raw','settings'];

const S={
  ruleText:null,pages:[],pageLines:[],paras:[],currentPara:-1,
  isPlaying:false,isGenerating:false,
  sections:{},markers:[],tocParas:new Set(),sectionStarts:[],
  openaiKey:localStorage.getItem('openaiKey')||'',
  claudeKey:localStorage.getItem('claudeKey')||'',
  ttsEngine:localStorage.getItem('ttsEngine')||'openai',
  ttsVoice:localStorage.getItem('ttsVoice')||'nova',
  ttsSpeed:+(localStorage.getItem('ttsSpeed')||'1.0'),
  ttsAbort:null,currentAudio:null,timeUpdater:null,
  browserVoice:null,
};

const VOICES=[{id:'nova',name:'Nova',desc:'æ˜ã‚‹ã„'},{id:'shimmer',name:'Shimmer',desc:'æŸ”ã‚‰ã‹'},{id:'alloy',name:'Alloy',desc:'ä¸­æ€§çš„'},{id:'onyx',name:'Onyx',desc:'ä½éŸ³'},{id:'fable',name:'Fable',desc:'ç‰©èªèª¿'},{id:'echo',name:'Echo',desc:'ã‚¯ãƒªã‚¢'}];
const ENGINES=[{id:'openai',name:'OpenAI TTS',desc:'é«˜å“è³ªãªéŸ³å£°åˆæˆã€‚APIã‚­ãƒ¼å¿…è¦',tag:'é«˜å“è³ª',tagCls:'tag-quality'},{id:'browser',name:'ãƒ–ãƒ©ã‚¦ã‚¶å†…è”µ',desc:'è¿½åŠ è¨­å®šä¸è¦ã€‚éŸ³è³ªã¯OSä¾å­˜',tag:'ç„¡æ–™',tagCls:'tag-free'}];
const SUMM=[{key:'objective',label:'ğŸ¯ ã‚²ãƒ¼ãƒ ã®ç›®çš„',prompt:'ã‚²ãƒ¼ãƒ ã®ç›®çš„ã‚’1ã€œ2æ–‡ã§'},{key:'winCondition',label:'ğŸ† å‹åˆ©æ¡ä»¶',prompt:'å‹åˆ©æ¡ä»¶ã‚’æ˜ç¢ºã«'},{key:'setup',label:'ğŸ“¦ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—',prompt:'ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®æº–å‚™æ‰‹é †'},{key:'turnFlow',label:'ğŸ”„ ã‚¿ãƒ¼ãƒ³ã®æµã‚Œ',prompt:'å„ã‚¿ãƒ¼ãƒ³ã§è¡Œã†ã“ã¨ã‚’ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã§'},{key:'actions',label:'âš¡ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§',prompt:'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå–ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸€è¦§ã¨èª¬æ˜'},{key:'specialRules',label:'âš ï¸ ç‰¹æ®Šãƒ«ãƒ¼ãƒ«',prompt:'ç‰¹æ®Šãƒ«ãƒ¼ãƒ«ã‚„ä¾‹å¤–å‡¦ç†'},{key:'tips',label:'ğŸ’¡ æ³¨æ„ç‚¹',prompt:'åˆå¿ƒè€…ãŒé–“é•ãˆã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆã‚„æ³¨æ„ç‚¹'}];

function init(){
  buildEngineGrid();buildVoiceGrid();setupUpload();updateKeyUI();buildSummSections();
  $('speedSlider').value=S.ttsSpeed;$('speedLabel').textContent=S.ttsSpeed.toFixed(2)+'x';
  $('openaiKeyInput').value=S.openaiKey;$('claudeKeyInput').value=S.claudeKey;
  // Preload browser voices
  if(window.speechSynthesis){speechSynthesis.onvoiceschanged=()=>{const v=speechSynthesis.getVoices();S.browserVoice=v.find(x=>x.lang.startsWith('ja'))||v.find(x=>x.lang.startsWith('en'))||v[0]}}
}

// === Tab switching ===
function switchTab(t){
  TABS.forEach(x=>{const el=$('tab-'+x);if(el)el.classList.toggle('hidden',x!==t);document.querySelectorAll(`[data-tab="${x}"]`).forEach(b=>b.classList.toggle('active',x===t))});
  // Show settings tab even before PDF loaded
  if(t==='settings'&&$('appScreen').classList.contains('hidden')){$('appScreen').classList.remove('hidden');$('uploadScreen').classList.add('hidden')}
}

// === Settings ===
function toggleVis(id,btn){const i=$(id);if(i.type==='password'){i.type='text';btn.textContent='ğŸ™ˆ'}else{i.type='password';btn.textContent='ğŸ‘'}}
function saveKey(w){if(w==='openai'){S.openaiKey=$('openaiKeyInput').value.trim();localStorage.setItem('openaiKey',S.openaiKey)}else{S.claudeKey=$('claudeKeyInput').value.trim();localStorage.setItem('claudeKey',S.claudeKey)};updateKeyUI()}
function updateKeyUI(){$('openaiKeyStatus').classList.toggle('hidden',!S.openaiKey);$('claudeKeyStatus').classList.toggle('hidden',!S.claudeKey);$('setupHint')&&$('setupHint').classList.toggle('hidden',!!S.claudeKey)}
function buildEngineGrid(){
  const g=$('engineGrid');g.innerHTML='';
  ENGINES.forEach(e=>{const b=document.createElement('button');b.className='engine-chip'+(S.ttsEngine===e.id?' active':'');b.innerHTML=`<div><span class="engine-name">${e.name}</span><span class="engine-tag ${e.tagCls}">${e.tag}</span></div><div class="engine-desc">${e.desc}</div>`;
    b.onclick=()=>{S.ttsEngine=e.id;localStorage.setItem('ttsEngine',e.id);g.querySelectorAll('.engine-chip').forEach(c=>c.classList.remove('active'));b.classList.add('active');$('openaiVoiceSettings').classList.toggle('hidden',e.id!=='openai')};g.appendChild(b)});
  $('openaiVoiceSettings').classList.toggle('hidden',S.ttsEngine!=='openai');
}
function buildVoiceGrid(){const g=$('voiceGrid');g.innerHTML='';VOICES.forEach(v=>{const b=document.createElement('button');b.className='voice-chip'+(S.ttsVoice===v.id?' active':'');b.innerHTML=`<span class="voice-name">${v.name}</span><span class="voice-desc">${v.desc}</span>`;b.onclick=()=>{S.ttsVoice=v.id;localStorage.setItem('ttsVoice',v.id);g.querySelectorAll('.voice-chip').forEach(c=>c.classList.remove('active'));b.classList.add('active')};g.appendChild(b)})}

// === Upload ===
function setupUpload(){
  const z=$('uploadZone'),f=$('fileInput');
  z.onclick=()=>f.click();
  f.onchange=()=>{if(f.files.length)handleFiles(f.files)};
  z.ondragover=e=>{e.preventDefault();z.classList.add('drag-over')};
  z.ondragleave=()=>z.classList.remove('drag-over');
  z.ondrop=e=>{e.preventDefault();z.classList.remove('drag-over');if(e.dataTransfer.files.length)handleFiles(e.dataTransfer.files)};
}
function handleFiles(fileList){
  const files=Array.from(fileList);
  const pdf=files.find(f=>f.type==='application/pdf'||f.name.endsWith('.pdf'));
  const images=files.filter(f=>f.type.startsWith('image/'));
  if(pdf)loadPDF(pdf);
  else if(images.length)loadImages(images);
  else alert('PDFã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
}

async function loadImages(files){
  if(!S.claudeKey){alert('ç”»åƒèª­ã¿å–ã‚Šã«ã¯Claude APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚è¨­å®šã‚¿ãƒ–ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');switchTab('settings');return}
  $('uploadContent').classList.add('hidden');$('uploadLoading').classList.remove('hidden');
  try{
    // Sort files by name
    files.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true}));
    S.pages=[];S.pageLines=[];let allText='';

    for(let i=0;i<files.length;i++){
      $('uploadStatus').textContent=`ç”»åƒã‚’èª­ã¿å–ã‚Šä¸­... (${i+1}/${files.length})`;
      const base64=await fileToBase64(files[i]);
      const mediaType=files[i].type||'image/png';

      // Send to Claude Vision for OCR
      const text=await ocrWithClaude(base64,mediaType,i+1,files.length);
      if(text){
        S.pages.push(text);
        S.pageLines.push([{text,fontSize:12}]);
        allText+=text+'\n\n';
      }
      // Rate limit between API calls
      if(i<files.length-1)await new Promise(r=>setTimeout(r,1000));
    }

    if(!S.pages.length){alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');$('uploadContent').classList.remove('hidden');$('uploadLoading').classList.add('hidden');return}

    S.ruleText=allText;S.sections={};S.currentPara=-1;S.markers=[];S.tocParas=new Set();S.sectionStarts=[];
    const name=files.length===1?files[0].name:`${files.length}æšã®ç”»åƒ`;
    $('fileNameBadge').textContent=name;$('fileBadge').classList.remove('hidden');$('resetBtn').style.display='';
    $('rawText').textContent=allText;
    buildFullText();
    $('uploadScreen').classList.add('hidden');$('appScreen').classList.remove('hidden');switchTab('reader');
  }catch(e){alert('ç”»åƒèª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: '+e.message)}
  $('uploadContent').classList.remove('hidden');$('uploadLoading').classList.add('hidden');
}

function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(r.result.split(',')[1]);
    r.onerror=()=>reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—'));
    r.readAsDataURL(file);
  });
}

async function ocrWithClaude(base64,mediaType,pageNum,totalPages){
  const res=await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{'Content-Type':'application/json','x-api-key':S.claudeKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
    body:JSON.stringify({
      model:'claude-haiku-4-5-20251001',
      max_tokens:4000,
      system:'ã‚ãªãŸã¯ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ç”»åƒã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æ­£ç¢ºã«èª­ã¿å–ã‚‹å°‚é–€å®¶ã§ã™ã€‚ç”»åƒå†…ã®å…¨ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿å–ã‚Šã€åŸæ–‡ã®ã¾ã¾å¿ å®Ÿã«å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æ®µè½æ§‹é€ ã‚’ä¿æŒã—ã€è¦‹å‡ºã—ã¨æœ¬æ–‡ã‚’åŒºåˆ¥ã—ã¦ãã ã•ã„ã€‚ç”»åƒå†…ã®ã‚¤ãƒ©ã‚¹ãƒˆã‚„å›³è¡¨ã®èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚ãƒ†ã‚­ã‚¹ãƒˆã®ã¿å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚',
      messages:[{role:'user',content:[
        {type:'image',source:{type:'base64',media_type:mediaType,data:base64}},
        {type:'text',text:`ã“ã®ç”»åƒï¼ˆ${pageNum}/${totalPages}ãƒšãƒ¼ã‚¸ç›®ï¼‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¨ã¦èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚è¦‹å‡ºã—ã¯ç‹¬ç«‹ã—ãŸè¡Œã«ã—ã€æ®µè½é–“ã¯ç©ºè¡Œã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚`}
      ]}]
    })
  });
  if(!res.ok){
    const e=await res.json().catch(()=>({}));
    if(res.status===429){await new Promise(r=>setTimeout(r,15000));return ocrWithClaude(base64,mediaType,pageNum,totalPages)}
    throw new Error(e.error?.message||'OCR API error: '+res.status);
  }
  const d=await res.json();
  return d.content?.[0]?.text||'';
}
async function loadPDF(file){
  $('uploadContent').classList.add('hidden');$('uploadLoading').classList.remove('hidden');
  try{
    const ab=await new Promise((resolve,reject)=>{const r=new FileReader();r.onload=()=>resolve(r.result);r.onerror=()=>reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—'));r.readAsArrayBuffer(file)});
    const pdf=await pdfjsLib.getDocument({data:new Uint8Array(ab)}).promise;
    S.pages=[];S.pageLines=[];let allText='';
    for(let i=1;i<=pdf.numPages;i++){
      const pg=await pdf.getPage(i);
      const content=await pg.getTextContent();
      // Build lines with font size info
      const lines=[];let curLine={text:'',y:null,x:null,fontSize:0,items:[]};
      for(const item of content.items){
        if(!item.str||!item.str.trim())continue;
        const y=Math.round(item.transform[5]);
        const x=Math.round(item.transform[4]);
        const fs=Math.round(item.height||Math.abs(item.transform[3])||12);
        if(curLine.y!==null&&Math.abs(y-curLine.y)>3){
          if(curLine.text.trim())lines.push({text:curLine.text.trim(),y:curLine.y,fontSize:curLine.fontSize,x:curLine.x});
          curLine={text:item.str,y,x,fontSize:fs,items:[item]};
        }else{
          // Same line - check for gap
          if(curLine.x!==null&&curLine.items.length>0){
            const lastItem=curLine.items[curLine.items.length-1];
            const lastEnd=lastItem.transform[4]+(lastItem.width||lastItem.str.length*5);
            if(x-lastEnd>fs*0.5)curLine.text+=' ';
          }
          curLine.text+=item.str;
          if(!curLine.y)curLine.y=y;
          if(!curLine.x)curLine.x=x;
          curLine.fontSize=Math.max(curLine.fontSize,fs);
          curLine.items.push(item);
        }
      }
      if(curLine.text.trim())lines.push({text:curLine.text.trim(),y:curLine.y,fontSize:curLine.fontSize,x:curLine.x});

      // Detect median font size for this page
      const sizes=lines.map(l=>l.fontSize).filter(s=>s>0);
      const medianFS=sizes.length?sizes.sort((a,b)=>a-b)[Math.floor(sizes.length/2)]:12;

      // Group lines into paragraphs based on font size changes and Y gaps
      const pageParagraphs=[];
      let buf='';let bufFS=0;
      for(let li=0;li<lines.length;li++){
        const line=lines[li];
        const prevLine=li>0?lines[li-1]:null;
        let breakBefore=false;

        if(prevLine){
          const yGap=Math.abs(prevLine.y-line.y);
          const avgFS=(prevLine.fontSize+line.fontSize)/2||12;
          // Large Y gap = paragraph break (increased threshold)
          if(yGap>avgFS*2.5)breakBefore=true;
          // Font size increased significantly AND line has substantial text (heading)
          if(line.fontSize>medianFS*1.3&&prevLine.fontSize<=medianFS*1.1&&line.text.length>5)breakBefore=true;
          // Heading ended - font size dropped back to normal AND previous was heading-like
          if(prevLine.fontSize>medianFS*1.3&&line.fontSize<=medianFS*1.1&&prevLine.text.length>5)breakBefore=true;
          // Section number pattern: must have meaningful text after the number
          if(/^\d{1,2}[\.\)]\s+\S{2,}/.test(line.text))breakBefore=true;
          // Japanese section markers with text
          if(/^[â– â—â—†â˜…ã€].{2,}/.test(line.text))breakBefore=true;
        }

        if(breakBefore&&buf.trim()){
          pageParagraphs.push({text:buf.trim(),fontSize:bufFS});
          buf='';bufFS=0;
        }
        buf+=(buf?' ':'')+line.text;
        bufFS=Math.max(bufFS,line.fontSize);
      }
      if(buf.trim())pageParagraphs.push({text:buf.trim(),fontSize:bufFS});

      // Merge very short paragraphs (< 10 chars) into neighbors
      const merged=[];
      for(let mi=0;mi<pageParagraphs.length;mi++){
        const p=pageParagraphs[mi];
        if(p.text.length<10&&merged.length>0&&!/^\d{1,2}[\.\)]\s/.test(p.text)){
          // Append to previous paragraph
          merged[merged.length-1].text+=' '+p.text;
        }else if(p.text.length<10&&mi<pageParagraphs.length-1&&!/^\d{1,2}[\.\)]\s/.test(p.text)){
          // Prepend to next paragraph
          pageParagraphs[mi+1].text=p.text+' '+pageParagraphs[mi+1].text;
        }else{
          merged.push({...p});
        }
      }

      // Store page text
      const pageText=merged.map(p=>p.text).join('\n\n');
      S.pages.push(pageText);
      S.pageLines.push(merged);
      allText+=pageText+'\n\n';
      pg.cleanup();
    }
    pdf.cleanup();pdf.destroy();
    S.ruleText=allText;S.sections={};S.currentPara=-1;S.markers=[];S.tocParas=new Set();S.sectionStarts=[];
    $('fileNameBadge').textContent=file.name;$('fileBadge').classList.remove('hidden');$('resetBtn').style.display='';
    $('rawText').textContent=allText;
    buildFullText();
    $('uploadScreen').classList.add('hidden');$('appScreen').classList.remove('hidden');switchTab('reader');
  }catch(e){alert('PDFèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: '+e.message)}
  $('uploadContent').classList.remove('hidden');$('uploadLoading').classList.add('hidden');
}
function resetApp(){stopAudio();S.ruleText=null;S.pages=[];S.pageLines=[];S.paras=[];S.sections={};S.currentPara=-1;$('fileBadge').classList.add('hidden');$('resetBtn').style.display='none';$('playbackBar').classList.add('hidden');$('appScreen').classList.add('hidden');$('uploadScreen').classList.remove('hidden');$('fileInput').value='';switchTab('reader')}

// === Build Full Text (page-based) ===
function buildFullText(){
  S.paras=[];const container=$('fulltext');container.innerHTML='';const nav=$('secNav');nav.innerHTML='';nav.classList.remove('hidden');
  S.pages.forEach((pageText,pi)=>{
    const navBtn=document.createElement('button');navBtn.className='sec-nav-btn';navBtn.textContent=`P${pi+1}`;navBtn.onclick=()=>{$('page-div-'+pi)?.scrollIntoView({behavior:'smooth',block:'start'})};nav.appendChild(navBtn);
    const divider=document.createElement('div');divider.className='page-divider';divider.id='page-div-'+pi;divider.innerHTML=`<div class="page-divider-line"></div><span class="page-divider-label">Page ${pi+1}</span><div class="page-divider-line"></div>`;container.appendChild(divider);

    // Use pageLines if available for better paragraph splitting (PDF)
    // For image-sourced text, pageLines has one element, so fall back to newline split
    let paragraphs=[];
    if(S.pageLines&&S.pageLines[pi]&&S.pageLines[pi].length>1){
      paragraphs=S.pageLines[pi].map(p=>p.text);
    }
    // Fallback: split by double newline (works well for Claude Vision OCR output)
    const rawP=paragraphs.length?paragraphs:pageText.split(/\n\s*\n+/).map(p=>p.trim()).filter(p=>p.length>3);

    // Further split very long paragraphs (>800 chars) at sentence boundaries
    const splitParas=[];
    rawP.forEach(p=>{
      if(p.length<=800){splitParas.push(p);return}
      // Split at section-number patterns within the text (e.g. "01. ã¯ã˜ã‚ã«")
      const parts=p.split(/(?=\d{1,2}[\.\)]\s+\S{2,})|(?=[â– â—â—†â˜…]\s*\S{2,})|(?=ã€.+?ã€‘)/).map(s=>s.trim()).filter(s=>s.length>10);
      if(parts.length>1){parts.forEach(pt=>splitParas.push(pt))}
      else{
        // Split at sentence boundaries for very long blocks
        const sents=p.split(/(?<=[ã€‚ï¼ï¼Ÿ])\s*/).filter(s=>s.length>2);
        let buf='';
        sents.forEach(s=>{
          if(buf.length+s.length>600&&buf.length>100){splitParas.push(buf.trim());buf=s}
          else buf+=(buf?' ':'')+s;
        });
        if(buf.trim())splitParas.push(buf.trim());
      }
    });

    if(!splitParas.length&&pageText.trim().length>3)splitParas.push(pageText.trim());
    splitParas.forEach(text=>{const idx=S.paras.length;const pObj={text,translated:null,el:null,isToc:false,page:pi};S.paras.push(pObj);const el=document.createElement('div');el.className='para';el.id='p-'+idx;el.textContent=text;el.onclick=()=>jumpTo(idx);container.appendChild(el);pObj.el=el});
  });
  $('playbackBar').classList.remove('hidden');$('translateBtn').classList.remove('hidden');$('statusText').textContent=`${S.pages.length}P / ${S.paras.length}æ®µè½`;updateBar();
}

// === Section Detection (Hybrid: pattern + AI) ===
const SEC_COLORS=['#f0a050','#50b0f0','#80d080','#e080c0','#c0a0f0','#f0d060','#60d0d0','#f08060'];
function getSecColor(i){return SEC_COLORS[i%SEC_COLORS.length]}

// Pattern-based heading detection
function detectHeadingsFromText(){
  const headings=[];
  S.paras.forEach((p,i)=>{
    const t=p.text.trim();
    const lines=t.split('\n');
    const firstLine=lines[0]?.trim()||'';
    // Short line that looks like a heading
    if(firstLine.length>2&&firstLine.length<80){
      // ALL CAPS English heading
      if(/^[A-Z][A-Z\s\d\-:&/]{2,}$/.test(firstLine)){headings.push({paraIdx:i,title:firstLine,confidence:0.8});return}
      // Numbered sections: "1. Setup", "2.1 Cards", "Section 3:", "Chapter 1"
      if(/^(\d+[\.\):]?\s+|Section\s+\d|Chapter\s+\d|Phase\s+\d|Step\s+\d|Part\s+\d)/i.test(firstLine)){headings.push({paraIdx:i,title:firstLine.replace(/^[\d\.\):]+\s*/,'').trim()||firstLine,confidence:0.7});return}
      // Japanese numbered sections: "1. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—", "ç¬¬1ç« "
      if(/^(\d+[\.\)]\s|ç¬¬\d+[ç« ç¯€éƒ¨å›]|â– |â—|â—†|â˜…|ã€)/.test(firstLine)){headings.push({paraIdx:i,title:firstLine.replace(/^[\d\.\)]+\s*/,'').replace(/^[â– â—â—†â˜…]\s*/,'').replace(/^ã€(.+?)ã€‘.*/,'$1').trim()||firstLine,confidence:0.7});return}
      // Short standalone line before longer content (likely a heading)
      if(firstLine.length<50&&lines.length>=2&&lines[1]?.trim().length>firstLine.length*2){headings.push({paraIdx:i,title:firstLine,confidence:0.5});return}
    }
  });
  return headings;
}

async function detectSections(){
  if(!S.claudeKey){switchTab('settings');return}
  $('tocBtn').disabled=true;$('tocBtn').textContent='â³ è§£æä¸­...';

  try{
    // Step 1: Find TOC paragraphs and extract section names
    $('statusText').textContent='ç›®æ¬¡ã‚’æ¤œå‡ºä¸­...';
    const allText=S.paras.map(p=>p.text).join('\n');

    // Detect TOC entries: lines like "01. ã¯ã˜ã‚ã«...2" or "Setup ......... 4" or "1. Introduction 3"
    const tocEntries=[];
    const tocParaSet=new Set();
    S.paras.forEach((p,pi)=>{
      const lines=p.text.split('\n');
      let tocLineCount=0;
      lines.forEach(line=>{
        const l=line.trim();
        // Match patterns: "01. Name...page" or "Name ..... page" or "1. Name 3"
        const m=l.match(/^(\d+[\.\)]\s*)?(.+?)\s*[\.â€¦Â·\-_]{3,}\s*(\d+)\s*$/)
          ||l.match(/^(\d+[\.\)]\s+)(.{2,50})\s+(\d+)\s*$/);
        if(m){
          const title=m[2].replace(/[\.â€¦Â·\-_\s]+$/,'').trim();
          if(title.length>=2&&title.length<80){
            tocEntries.push({title,page:parseInt(m[3]),paraIdx:pi});
            tocLineCount++;
          }
        }
      });
      // Also extract from concatenated text (PDF.js sometimes merges TOC into one blob)
      // e.g. "2 ç›®æ¬¡ 01. ã¯ã˜ã‚ã« ... 2 02. ã‚²ãƒ¼ãƒ ã®ç›®çš„ ... 2 03."
      if(tocLineCount===0){
        const text=p.text;
        // Look for repeated "NN. Title ...page" pattern
        const multiMatch=[...text.matchAll(/(\d{1,2})[\.\)]\s*([^\d\.â€¦]{2,30}?)\s*[\.â€¦Â·\-_]*\s*(?=\d{1,3}\s|\d{1,2}[\.\)]|$)/g)];
        if(multiMatch.length>=3){
          multiMatch.forEach(mm=>{
            const title=mm[2].trim().replace(/[\.â€¦Â·\-_\s]+$/,'');
            if(title.length>=2&&title.length<60)tocEntries.push({title,page:-1,paraIdx:pi});
          });
          tocLineCount=multiMatch.length;
        }
      }
      if(tocLineCount>=2)tocParaSet.add(pi);
    });

    // Step 2: If no TOC found by pattern, ask AI to extract
    if(tocEntries.length<3){
      $('statusText').textContent='AIã§ç›®æ¬¡è§£æä¸­...';
      const tocResult=await callClaude(`ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ç›®æ¬¡ï¼ˆTable of Contentsï¼‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã‚’å…¨ã¦æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
ç›®æ¬¡ãŒæ˜ç¤ºçš„ã«ãªã„å ´åˆã¯ã€è¦‹å‡ºã—ã‚„ç« ç«‹ã¦ã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚
JSONå½¢å¼ã®ã¿: {"entries":["ã‚»ã‚¯ã‚·ãƒ§ãƒ³å1","ã‚»ã‚¯ã‚·ãƒ§ãƒ³å2",...]}
ç•ªå·ã‚„ãƒšãƒ¼ã‚¸ç•ªå·ã¯é™¤ãã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã®ã¿æŠ½å‡ºã€‚`,S.ruleText.slice(0,10000));
      if(tocResult){
        try{
          const j=tocResult.match(/\{[\s\S]*\}/);
          const d=j?JSON.parse(j[0]):{};
          if(Array.isArray(d.entries)){
            tocEntries.length=0;
            d.entries.forEach(t=>{if(typeof t==='string'&&t.length>=2)tocEntries.push({title:t.trim(),page:-1,paraIdx:-1})});
          }
        }catch(e){}
      }
    }

    if(!tocEntries.length){
      showError('ç›®æ¬¡ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
      $('tocBtn').disabled=false;$('tocBtn').textContent='ğŸ“‘ ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Š';
      $('statusText').textContent='';return;
    }

    // Step 3: Match each TOC entry to a body paragraph by string matching
    $('statusText').textContent=`${tocEntries.length}é …ç›®ã‚’æœ¬æ–‡ã«ãƒãƒƒãƒä¸­...`;
    const sectionStarts=[];
    const usedParas=new Set();

    tocEntries.forEach((entry,ei)=>{
      const title=entry.title;
      // Normalize for matching: remove spaces, punctuation, lowercase
      const normalize=s=>s.replace(/[\sã€€\u3000]+/g,'').replace(/[ãƒ»\-:ï¼šã€ã€‚]/g,'').toLowerCase();
      const normTitle=normalize(title);
      if(normTitle.length<2)return;
      
      let bestMatch=-1;let bestScore=0;
      S.paras.forEach((p,pi)=>{
        if(tocParaSet.has(pi))return; // skip TOC paragraphs themselves
        if(usedParas.has(pi))return;
        const normText=normalize(p.text);
        const firstLine=normalize((p.text.split('\n')[0]||'').slice(0,100));
        
        // Check for "01 ã¯ã˜ã‚ã«" or "01. ã¯ã˜ã‚ã«" pattern at start
        const normTextNoNum=normText.replace(/^\d{1,2}[\.\)]*\s*/,'');
        const firstLineNoNum=firstLine.replace(/^\d{1,2}[\.\)]*\s*/,'');

        // Best: title matches start of paragraph (with or without number prefix)
        if(firstLineNoNum.startsWith(normTitle)||firstLine.startsWith(normTitle)){
          const score=100;
          if(score>bestScore){bestScore=score;bestMatch=pi}
        }
        // Good: title matches start of paragraph text (without number)
        else if(normTextNoNum.startsWith(normTitle)){
          const score=90;
          if(score>bestScore){bestScore=score;bestMatch=pi}
        }
        // OK: first line contains the title
        else if(firstLine.includes(normTitle)){
          const score=80-Math.min(30,Math.abs(firstLine.length-normTitle.length));
          if(score>bestScore){bestScore=score;bestMatch=pi}
        }
        // Fallback: paragraph text contains the title near the start
        else if(normText.indexOf(normTitle)>=0&&normText.indexOf(normTitle)<100){
          const score=60;
          if(score>bestScore){bestScore=score;bestMatch=pi}
        }
      });
      
      if(bestMatch>=0&&bestScore>=50){
        usedParas.add(bestMatch);
        sectionStarts.push({paraIdx:bestMatch,title:title,level:1});
      }
    });

    // Sort by paragraph order
    sectionStarts.sort((a,b)=>a.paraIdx-b.paraIdx);

    S.tocParas=tocParaSet;
    S.sectionStarts=sectionStarts;

    // Fallback: pattern-based detection
    if(!S.sectionStarts.length){
      const patternHeadings=detectHeadingsFromText();
      if(patternHeadings.length)S.sectionStarts=patternHeadings.map(h=>({paraIdx:h.paraIdx,title:h.title,level:1}));
    }

    renderWithSections();
    $('statusText').textContent=`âœ“ ${S.sectionStarts.length}ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ¤œå‡º`;
  }catch(e){
    const patternHeadings=detectHeadingsFromText();
    if(patternHeadings.length){
      S.sectionStarts=patternHeadings.map(h=>({paraIdx:h.paraIdx,title:h.title,level:1}));
      S.tocParas=new Set();
      renderWithSections();$('statusText').textContent=`âœ“ ${S.sectionStarts.length}ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º)`;
    }else{showError('è§£æã‚¨ãƒ©ãƒ¼: '+e.message);$('statusText').textContent=''}
  }
  $('tocBtn').disabled=false;$('tocBtn').textContent='ğŸ“‘ ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Š';
}

function renderWithSections(){
  const container=$('fulltext');container.innerHTML='';
  // Assign color index: level 1 sections get unique colors, subsections inherit parent color
  let colorIdx=0;
  const secMap=new Map();
  S.sectionStarts?.forEach((s,si)=>{
    if(s.level===1)colorIdx=si;
    secMap.set(s.paraIdx,{title:s.title,colorIdx:colorIdx,level:s.level||1,idx:si});
  });

  // Build para-to-section mapping
  let currentSecIdx=-1;
  S.paras.forEach((p,i)=>{
    if(secMap.has(i))currentSecIdx=secMap.get(i).colorIdx;
    p.secIdx=currentSecIdx;
  });

  let lastPage=-1;
  S.paras.forEach((p,i)=>{
    const isToc=S.tocParas?.has(i);
    if(p.page!==lastPage){lastPage=p.page;const d=document.createElement('div');d.className='page-divider';d.id='page-div-'+p.page;d.innerHTML=`<div class="page-divider-line"></div><span class="page-divider-label">Page ${p.page+1}</span><div class="page-divider-line"></div>`;container.appendChild(d)}
    if(isToc&&(i===0||!S.tocParas?.has(i-1))){const l=document.createElement('div');l.className='toc-label';l.innerHTML='ğŸ“‘ ç›®æ¬¡ã‚¨ãƒªã‚¢ <button onclick="skipToContent()">â–¶ æœ¬æ–‡ã¸</button>';container.appendChild(l)}
    if(secMap.has(i)){
      const sec=secMap.get(i);const color=getSecColor(sec.colorIdx);const level=sec.level||1;
      const d=document.createElement('div');d.className='sec-divider';d.id='sec-div-'+i;
      // Level-based styling
      const fontSize=level===1?'13px':level===2?'11px':'10px';
      const fontWeight=level===1?'700':level===2?'600':'500';
      const margin=level===1?'20px -10px 8px':level===2?'14px -10px 4px':'8px -10px 2px';
      const indent=level===1?'0':level===2?'12px':'24px';
      const lineH=level===1?'2px':'1px';
      const opacity=level===1?'1':level===2?'0.85':'0.7';
      const prefix=level===1?'â–Œ ':level===2?'â”œ ':'â”” ';
      d.style.cssText=`display:flex;align-items:center;gap:8px;margin:${margin};padding:0 10px;padding-left:calc(10px + ${indent})`;
      d.innerHTML=`<div style="flex:1;height:${lineH};background:linear-gradient(90deg,transparent,${color})"></div><span style="font-size:${fontSize};font-weight:${fontWeight};color:${color};white-space:nowrap;max-width:65%;overflow:hidden;text-overflow:ellipsis;opacity:${opacity}">${prefix}${esc(sec.title)}</span><div style="flex:1;height:${lineH};background:linear-gradient(90deg,${color},transparent)"></div><button class="sec-play-btn" style="border-color:${color};color:${color};width:${level===1?'26':'22'}px;height:${level===1?'26':'22'}px;font-size:${level===1?'12':'10'}px" onclick="playSection(${i})" title="ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å†ç”Ÿ">â–¶</button>`;
      container.appendChild(d);
    }
    const el=document.createElement('div');el.className='para'+(isToc?' toc-para':'');el.id='p-'+i;el.textContent=p.translated||p.text;el.onclick=()=>jumpTo(i);
    // Color-code section
    if(p.secIdx>=0&&!isToc){
      const color=getSecColor(p.secIdx);
      el.style.borderLeftColor=color;
      el.style.borderLeftWidth='3px';
    }
    container.appendChild(el);p.el=el;p.isToc=isToc;
  });
  buildSecNav();
}

// Play only paragraphs in a specific section
function playSection(startParaIdx){
  const secIdx=S.paras[startParaIdx]?.secIdx;
  if(secIdx===undefined||secIdx<0)return;
  // Find end of section
  let endIdx=S.paras.length;
  for(let i=startParaIdx+1;i<S.paras.length;i++){
    if(S.paras[i].secIdx!==secIdx&&S.paras[i].secIdx>=0){endIdx=i;break}
  }
  stopAudio();
  playSectionRange(startParaIdx,endIdx);
}

async function playSectionRange(startIdx,endIdx){
  const useOpenAI=S.ttsEngine==='openai';
  if(useOpenAI&&!S.openaiKey){switchTab('settings');showError('OpenAI APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™');return}
  const controller=new AbortController();S.ttsAbort=controller;
  let prefetchPromise=null;let prefetchIdx=-1;
  function nextIdx(from){for(let j=from+1;j<endIdx;j++){if(!S.paras[j].isToc)return j};return -1}
  function startPrefetch(idx){if(idx<0||idx>=endIdx||!useOpenAI)return;const text=S.paras[idx].translated||S.paras[idx].text;const chunks=splitTTS(text);if(!chunks.length)return;prefetchIdx=idx;prefetchPromise=Promise.all(chunks.map(c=>fetchTTS(c).catch(()=>null)))}

  for(let i=startIdx;i<endIdx;i++){
    if(controller.signal.aborted)return;
    if(S.paras[i].isToc)continue;
    S.currentPara=i;S.isGenerating=true;S.isPlaying=false;updateHighlights();updateBar();
    S.paras[i].el.scrollIntoView({behavior:'smooth',block:'center'});
    const text=S.paras[i].translated||S.paras[i].text;
    if(useOpenAI){
      const chunks=splitTTS(text);if(!chunks.length){S.isGenerating=false;continue}
      try{
        let urls;
        if(prefetchIdx===i&&prefetchPromise){urls=await prefetchPromise;prefetchPromise=null;prefetchIdx=-1}
        else{urls=[];for(let ci=0;ci<chunks.length;ci++){if(controller.signal.aborted)return;$('pbSub').textContent=chunks.length>1?`ç”Ÿæˆä¸­ (${ci+1}/${chunks.length})`:'ç”Ÿæˆä¸­...';urls.push(await fetchTTS(chunks[ci]))}}
        if(controller.signal.aborted){urls.forEach(u=>{if(u)releaseAudioUrl(u)});return}
        const ni=nextIdx(i);if(ni>=0)startPrefetch(ni);
        S.isGenerating=false;S.isPlaying=true;updateHighlights();updateBar();
        for(let ci=0;ci<urls.length;ci++){if(controller.signal.aborted)return;if(!urls[ci])continue;$('pbSub').textContent=urls.length>1?`å†ç”Ÿä¸­ ${ci+1}/${urls.length}`:'å†ç”Ÿä¸­';await playAudioUrl(urls[ci],controller,ci,urls.length);releaseAudioUrl(urls[ci])}
      }catch(e){if(!controller.signal.aborted){showError(`æ®µè½${i+1}: ${e.message}`);S.isPlaying=false;S.isGenerating=false;updateBar();await new Promise(r=>setTimeout(r,2000))}}
    }else{
      S.isGenerating=false;S.isPlaying=true;updateHighlights();updateBar();$('pbSub').textContent='å†ç”Ÿä¸­';
      try{await playBrowserTTS(cleanForTTS(text),controller)}catch(e){if(!controller.signal.aborted){S.isPlaying=false;updateBar()}}
    }
    S.isGenerating=false;
  }
  if(!controller.signal.aborted){S.isPlaying=false;S.isGenerating=false;$('pbTitle').textContent='âœ“ ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†ç”Ÿå®Œäº†';$('pbSub').textContent='';$('pbTime').textContent='';$('pbFill').style.width='100%';updateBar()}
}

function buildSecNav(){
  const nav=$('secNav');nav.innerHTML='';nav.classList.remove('hidden');
  // Page buttons
  S.pages.forEach((pt,pi)=>{const b=document.createElement('button');b.className='sec-nav-btn';b.textContent=`P${pi+1}`;b.onclick=()=>$('page-div-'+pi)?.scrollIntoView({behavior:'smooth',block:'start'});nav.appendChild(b)});
  if(S.sectionStarts?.length){
    const sep=document.createElement('span');sep.style.cssText='width:1px;height:18px;background:var(--border);flex-shrink:0;margin:0 3px';nav.appendChild(sep);
    let colorIdx=0;
    S.sectionStarts.forEach((s,si)=>{
      if(s.level===1)colorIdx=si;
      const color=getSecColor(colorIdx);
      const b=document.createElement('button');b.className='sec-nav-btn';
      b.style.borderColor=color;b.style.color=color;
      if(s.level>=2){b.style.fontSize='10px';b.style.padding='2px 6px';b.style.opacity='0.75'}
      b.textContent=(s.level>=2?'Â· ':'')+s.title;
      b.onclick=()=>$('sec-div-'+s.paraIdx)?.scrollIntoView({behavior:'smooth',block:'start'});
      nav.appendChild(b);
    });
  }
}
function skipToContent(){const i=S.paras.findIndex(p=>!p.isToc);if(i>=0)S.paras[i].el.scrollIntoView({behavior:'smooth',block:'start'})}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// === Highlights ===
function updateHighlights(){const cur=S.currentPara;S.paras.forEach((p,i)=>{let cls='para';if(p.isToc)cls+=' toc-para';if(cur>=0){if(i<cur)cls+=' done';else if(i===cur){if(S.isGenerating)cls+=' generating';else if(S.isPlaying)cls+=' playing'}};p.el.className=cls;if(p.secIdx>=0&&!p.isToc&&!(cur>=0&&i===cur)){p.el.style.borderLeftColor=getSecColor(p.secIdx);p.el.style.borderLeftWidth='3px'}else if(cur>=0&&i===cur){p.el.style.borderLeftWidth='3px'}else{p.el.style.borderLeftColor='';p.el.style.borderLeftWidth=''}})}

// === Playback ===
// iOS Safari requires user-gesture to unlock audio. We create a shared Audio element
// on first user click and reuse it, so auto-advance to next paragraph works.
let _iosAudioUnlocked=false;
let _audioPool=[];

function unlockAudio(){
  if(_iosAudioUnlocked)return;
  _iosAudioUnlocked=true;
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const buf=ctx.createBuffer(1,1,22050);
    const src=ctx.createBufferSource();
    src.buffer=buf;src.connect(ctx.destination);src.start(0);
    ctx.resume();
  }catch(e){}
  // Pre-create pool of Audio elements with silent src to unlock iOS
  for(let i=0;i<3;i++){
    const a=new Audio();
    a.src='data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYoRwMHAAAAAAD/+1AEAAAAAAL0AAAAAgAAXoAAAAEEAAGkAAAAIAAANIAAAAQAABGkJAAACEAAAAIwAAAAAAAAAAAAA//tQBAAAAAAAADSAAAAAAAAA0gAAABAAAABpAAAACAAADSAAAAIAAAAMf/7UAQAAAABkA0gAAAAAAANIAAAAAAAAA0gAAAAAAABpAAAAA';
    a.load();
    a.volume=1;
    _audioPool.push(a);
  }
}
function getPooledAudio(){
  if(_audioPool.length>0)return _audioPool.pop();
  return new Audio();
}
document.addEventListener('touchstart',unlockAudio,{once:true});
document.addEventListener('click',unlockAudio,{once:true});

function stopAudio(){if(S.ttsAbort){S.ttsAbort.abort();S.ttsAbort=null};if(S.currentAudio){if(S.timeUpdater)S.currentAudio.removeEventListener('timeupdate',S.timeUpdater);S.currentAudio.pause();S.currentAudio.src='';S.currentAudio=null};if(window.speechSynthesis)speechSynthesis.cancel();S.isPlaying=false;S.isGenerating=false}
function stopAndReset(){stopAudio();S.currentPara=-1;updateHighlights();updateBar()}
function jumpTo(idx){stopAudio();playFrom(idx)}
function togglePlay(){if(S.isPlaying||S.isGenerating){stopAudio();updateBar();updateHighlights();return};playFrom(S.currentPara>=0?S.currentPara:0)}

async function playFrom(startIdx){
  const useOpenAI=S.ttsEngine==='openai';
  if(useOpenAI&&!S.openaiKey){switchTab('settings');showError('OpenAI APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™');return}
  const controller=new AbortController();S.ttsAbort=controller;
  let prefetchPromise=null;let prefetchIdx=-1;

  // Find next valid paragraph index
  function nextIdx(from){for(let j=from+1;j<S.paras.length;j++){if(!S.paras[j].isToc||j===from+1)return j};return -1}

  // Prefetch next paragraph's audio
  function startPrefetch(idx){
    if(idx<0||idx>=S.paras.length||!useOpenAI)return;
    const text=S.paras[idx].translated||S.paras[idx].text;
    const chunks=splitTTS(text);
    if(!chunks.length)return;
    prefetchIdx=idx;
    prefetchPromise=Promise.all(chunks.map(c=>fetchTTS(c).catch(()=>null)));
  }

  for(let i=startIdx;i<S.paras.length;i++){
    if(controller.signal.aborted)return;
    if(S.paras[i].isToc&&i!==startIdx)continue;
    S.currentPara=i;S.isGenerating=true;S.isPlaying=false;updateHighlights();updateBar();
    S.paras[i].el.scrollIntoView({behavior:'smooth',block:'center'});
    const text=S.paras[i].translated||S.paras[i].text;
    if(useOpenAI){
      const chunks=splitTTS(text);if(!chunks.length){S.isGenerating=false;continue}
      try{
        // Use prefetched audio if available for this paragraph
        let urls;
        if(prefetchIdx===i&&prefetchPromise){
          $('pbSub').textContent='æº–å‚™æ¸ˆã¿...';
          urls=await prefetchPromise;
          prefetchPromise=null;prefetchIdx=-1;
        }else{
          urls=[];
          for(let ci=0;ci<chunks.length;ci++){
            if(controller.signal.aborted)return;
            $('pbSub').textContent=chunks.length>1?`ç”Ÿæˆä¸­ (${ci+1}/${chunks.length})`:'ç”Ÿæˆä¸­...';
            urls.push(await fetchTTS(chunks[ci]));
          }
        }
        if(controller.signal.aborted){urls.forEach(u=>{if(u)releaseAudioUrl(u)});return}

        // Start prefetching next paragraph
        const ni=nextIdx(i);
        if(ni>=0)startPrefetch(ni);

        S.isGenerating=false;S.isPlaying=true;updateHighlights();updateBar();
        for(let ci=0;ci<urls.length;ci++){
          if(controller.signal.aborted)return;
          if(!urls[ci])continue;
          $('pbSub').textContent=urls.length>1?`å†ç”Ÿä¸­ ${ci+1}/${urls.length}`:'å†ç”Ÿä¸­';
          await playAudioUrl(urls[ci],controller,ci,urls.length);
          releaseAudioUrl(urls[ci]);
        }
      }catch(e){if(!controller.signal.aborted){showError(`æ®µè½${i+1}: ${e.message}`);S.isPlaying=false;S.isGenerating=false;updateBar();await new Promise(r=>setTimeout(r,2000))}}
    }else{
      S.isGenerating=false;S.isPlaying=true;updateHighlights();updateBar();$('pbSub').textContent='å†ç”Ÿä¸­';
      try{await playBrowserTTS(cleanForTTS(text),controller)}catch(e){if(!controller.signal.aborted){S.isPlaying=false;updateBar()}}
    }
    S.isGenerating=false;
  }
  if(!controller.signal.aborted){S.isPlaying=false;S.isGenerating=false;$('pbTitle').textContent='âœ“ æœ—èª­å®Œäº†';$('pbSub').textContent='';$('pbTime').textContent='';$('pbFill').style.width='100%';updateBar()}
}

function playAudioUrl(url,controller,ci,total){
  return new Promise((resolve,reject)=>{
    const a=getPooledAudio();
    a.src=url;
    a.volume=1;
    S.currentAudio=a;
    S.timeUpdater=()=>{if(a.duration&&isFinite(a.duration)){$('pbFill').style.width=Math.round((ci+a.currentTime/a.duration)/total*100)+'%';$('pbTime').textContent=fmtTime(Math.floor(a.currentTime))+'/'+fmtTime(Math.floor(a.duration))}};
    a.addEventListener('timeupdate',S.timeUpdater);
    a.onended=()=>{a.removeEventListener('timeupdate',S.timeUpdater);resolve()};
    a.onerror=e=>{a.removeEventListener('timeupdate',S.timeUpdater);reject(e)};
    controller.signal.addEventListener('abort',()=>{a.removeEventListener('timeupdate',S.timeUpdater);a.pause();a.src='';resolve()},{once:true});
    a.play().catch(e=>{
      if(e.name==='NotAllowedError'){
        showError('éŸ³å£°å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„');
        resolve();
      }else reject(e);
    });
  })
}
function playBrowserTTS(text,controller){
  return new Promise((resolve,reject)=>{if(!window.speechSynthesis){reject(new Error('ãƒ–ãƒ©ã‚¦ã‚¶TTSéå¯¾å¿œ'));return};const u=new SpeechSynthesisUtterance(text);u.rate=S.ttsSpeed;u.lang='ja-JP';if(S.browserVoice)u.voice=S.browserVoice;u.onend=resolve;u.onerror=e=>{if(e.error!=='canceled')reject(e);else resolve()};controller.signal.addEventListener('abort',()=>{speechSynthesis.cancel();resolve()},{once:true});speechSynthesis.speak(u)})}

function fmtTime(s){return Math.floor(s/60)+':'+(''+(s%60)).padStart(2,'0')}
function skipTime(d){if(S.currentAudio&&S.isPlaying)S.currentAudio.currentTime=Math.max(0,Math.min(S.currentAudio.currentTime+d,S.currentAudio.duration||0))}
function seekAudio(e){if(S.currentAudio&&S.isPlaying&&S.currentAudio.duration){const r=e.currentTarget.getBoundingClientRect();S.currentAudio.currentTime=Math.max(0,Math.min(1,(e.clientX-r.left)/r.width))*S.currentAudio.duration}}
function updateBar(){const playing=S.isPlaying||S.isGenerating;$('pbPlayBtn').textContent=playing?'â¸':'â–¶';$('playAllBtn').textContent=playing?'â¸ ä¸€æ™‚åœæ­¢':'â–¶ '+(S.currentPara>0?'ç¶šãã‹ã‚‰':'æœ€åˆã‹ã‚‰å†ç”Ÿ');if(S.currentPara>=0&&S.currentPara<S.paras.length){const p=S.paras[S.currentPara];$('pbTitle').textContent=`P${(p.page||0)+1} (${S.currentPara+1}/${S.paras.length}): ${(p.translated||p.text).slice(0,50).replace(/\n/g,' ')}â€¦`}else if(!playing){$('pbTitle').textContent='æ®µè½ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†ç”Ÿ';$('pbSub').textContent='';$('pbTime').textContent=''}}
function showError(m){$('ttsErrorMsg').textContent='âš ï¸ '+m;$('ttsError').classList.remove('hidden')}

// === TTS ===
function cleanForTTS(t){let s=t;s=s.replace(/([a-z])([A-Z])/g,'$1 $2');s=s.replace(/\.{3,}/g,'').replace(/â€¦+/g,'').replace(/[â”€â”â•ï¼]{2,}/g,'').replace(/[â˜…â˜†â—â—‹â—†â—‡â– â–¡â–²â–³â–¼â–½â™¦â™£â™ â™¥â€»ï¼Š]+/g,'').replace(/[_~`|]{2,}/g,'').replace(/#{1,}\s*/g,'').replace(/\b[Pp]age\s*\d+\b/gi,'').replace(/-\s*\d+\s*-/g,'').replace(/^\d+\s*$/gm,'').replace(/^[ãƒ»\-\*â€¢â—¦â–¸â–º]\s*/gm,'').replace(/https?:\/\/\S+/g,'').replace(/[Â©Â®â„¢]/g,'').replace(/\([^)]*\.(png|jpg|svg|gif)\)/gi,'').replace(/\n{3,}/g,'\n\n').replace(/[ \t]{2,}/g,' ').replace(/^\s+$/gm,'').trim();return s}
function splitTTS(t,max=4000){const c=cleanForTTS(t);if(!c)return[];if(c.length<=max)return[c];const chunks=[];let r=c;while(r.length>0){if(r.length<=max){chunks.push(r);break};let sp=-1;for(const sep of['ã€‚','ï¼','ï¼Ÿ','.\n','! ','? ','. ']){const i=r.lastIndexOf(sep,max);if(i>max*.3){sp=i+sep.length;break}};if(sp<0){const i=r.lastIndexOf('\n',max);if(i>max*.3)sp=i+1};if(sp<0){for(const sep of['ã€',', ','; ']){const i=r.lastIndexOf(sep,max);if(i>max*.4){sp=i+sep.length;break}}};if(sp<0)sp=max;chunks.push(r.slice(0,sp).trim());r=r.slice(sp).trim()};return chunks.filter(c=>c.length>0)}
const _isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||(/Macintosh/.test(navigator.userAgent)&&navigator.maxTouchPoints>1);
async function fetchTTS(text,retries=2){const ac=new AbortController(),t=setTimeout(()=>ac.abort(),30000);try{const res=await fetch('https://api.openai.com/v1/audio/speech',{method:'POST',headers:{'Authorization':'Bearer '+S.openaiKey,'Content-Type':'application/json'},body:JSON.stringify({model:'tts-1-hd',input:text,voice:S.ttsVoice,speed:S.ttsSpeed,response_format:'mp3'}),signal:ac.signal});clearTimeout(t);if(!res.ok){const e=await res.json().catch(()=>({}));if(res.status===429&&retries>0){await new Promise(r=>setTimeout(r,3000));return fetchTTS(text,retries-1)};throw new Error(e.error?.message||'TTS error '+res.status)};const blob=await res.blob();if(blob.size<100)throw new Error('ç©ºã®éŸ³å£°');if(_isIOS){const dataUrl=await new Promise((resolve,reject)=>{const r=new FileReader();r.onload=()=>resolve(r.result);r.onerror=reject;r.readAsDataURL(blob)});return dataUrl}else{return URL.createObjectURL(blob)}}catch(e){clearTimeout(t);if(e.name==='AbortError'){if(retries>0){await new Promise(r=>setTimeout(r,2000));return fetchTTS(text,retries-1)};throw new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')};if(retries>0&&!e.message?.includes('APIã‚­ãƒ¼')){await new Promise(r=>setTimeout(r,2000));return fetchTTS(text,retries-1)};throw e}}
function releaseAudioUrl(url){if(!_isIOS&&url&&url.startsWith('blob:'))URL.revokeObjectURL(url)}

// === Translate ===
async function translateAll(){if(!S.claudeKey){switchTab('settings');return};$('translateBtn').disabled=true;$('translateBtn').textContent='â³ ç¿»è¨³ä¸­...';const t=S.paras.filter(p=>!p.translated);for(let i=0;i<t.length;i++){$('statusText').textContent=`ç¿»è¨³ä¸­ ${i+1}/${t.length}`;try{const r=await callClaude('ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’è‡ªç„¶ãªæ—¥æœ¬èªã«ç¿»è¨³ã€‚ç¿»è¨³ã®ã¿å‡ºåŠ›ã€‚',t[i].text.slice(0,5000));if(r){t[i].translated=r;t[i].el.textContent=r};await new Promise(r=>setTimeout(r,1500))}catch(e){showError('ç¿»è¨³ã‚¨ãƒ©ãƒ¼: '+e.message);break}};$('translateBtn').disabled=false;$('translateBtn').textContent='ğŸŒ ç¿»è¨³';$('statusText').textContent=`${S.pages.length}P / ${S.paras.length}æ®µè½`}

// === Claude API ===
async function callClaude(sys,msg){if(!S.claudeKey){switchTab('settings');return null};const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':S.claudeKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:3000,system:sys,messages:[{role:'user',content:msg}]})});if(!res.ok){const d=await res.json().catch(()=>({}));if(res.status===429){await new Promise(r=>setTimeout(r,15000));return callClaude(sys,msg)};throw new Error(d.error?.message||'API error: '+res.status)};const d=await res.json();if(d.error)throw new Error(d.error.message);return d.content?.[0]?.text||null}

// === Summary ===
function buildSummSections(){const c=$('sectionsContainer');c.innerHTML='';SUMM.forEach(s=>{c.innerHTML+=`<div class="card" id="sc-${s.key}"><div class="card-head"><h3>${s.label}</h3><div style="display:flex;gap:4px"><button class="icon-btn hidden" id="sp-${s.key}" onclick="speakSec('${s.key}')">ğŸ”Š</button><button class="icon-btn" id="sa-${s.key}" onclick="analyzeSec('${s.key}')">âœ¨</button></div></div><div class="card-body"><div class="placeholder" id="sph-${s.key}">âœ¨ ã‚’æŠ¼ã—ã¦è§£æ</div><div class="hidden" id="sl-${s.key}" style="color:var(--blue);font-size:12px"><div class="dot-anim"><span></span><span></span><span></span></div> è§£æä¸­...</div><div class="hidden" id="st-${s.key}"></div></div></div>`})}
async function analyzeSec(k){const s=SUMM.find(x=>x.key===k);$('sph-'+k).classList.add('hidden');$('sl-'+k).classList.remove('hidden');$('st-'+k).classList.add('hidden');$('sa-'+k).classList.add('hidden');try{const r=await callClaude(`ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«è§£èª¬ã®å°‚é–€å®¶ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ã‹ã‚‰ã€Œ${s.prompt}ã€ã‚’æ—¥æœ¬èªã§æ•´ç†ã€‚å…·ä½“çš„æ•°å€¤ã‚’çœç•¥ã›ãšã€è‡ªç„¶ãªæ–‡ç« ã§ã€‚è‹±èªãªã‚‰ç¿»è¨³ã€‚`,S.ruleText.slice(0,8000));if(r){S.sections[k]=r;$('st-'+k).textContent=r;$('st-'+k).classList.remove('hidden');$('sp-'+k).classList.remove('hidden');$('sc-'+k).classList.add('accent')}}catch(e){$('st-'+k).textContent='ã‚¨ãƒ©ãƒ¼: '+e.message;$('st-'+k).classList.remove('hidden');$('sa-'+k).classList.remove('hidden')};$('sl-'+k).classList.add('hidden')}
async function analyzeAll(){$('analyzeAllBtn').disabled=true;for(const s of SUMM){if(!S.sections[s.key]){await analyzeSec(s.key);await new Promise(r=>setTimeout(r,1500))}};$('analyzeAllBtn').disabled=false}
async function speakSec(k){if(S.sections[k])playDirect(S.sections[k])}
async function playDirect(text){stopAudio();const ctrl=new AbortController();S.ttsAbort=ctrl;if(S.ttsEngine==='openai'&&S.openaiKey){const chunks=splitTTS(text);try{for(const ch of chunks){if(ctrl.signal.aborted)return;const url=await fetchTTS(ch);if(ctrl.signal.aborted){releaseAudioUrl(url);return};await playAudioUrl(url,ctrl,0,1);releaseAudioUrl(url)}}catch(e){if(!ctrl.signal.aborted)showError(e.message)}}else{try{await playBrowserTTS(cleanForTTS(text),ctrl)}catch(e){}}}

// === Glossary ===
async function generateGlossary(){
  if(!S.claudeKey){switchTab('settings');return}
  $('glossaryBtn').disabled=true;$('glossaryBtn').textContent='â³ æŠ½å‡ºä¸­...';$('glossaryContent').innerHTML='<div style="color:var(--blue);font-size:12px"><div class="dot-anim"><span></span><span></span><span></span></div> ç”¨èªã‚’æŠ½å‡ºä¸­...</div>';
  try{
    const r=await callClaude(`ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«å°‚é–€å®¶ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ã‹ã‚‰å°‚é–€ç”¨èªãƒ»ã‚²ãƒ¼ãƒ å›ºæœ‰ç”¨èªã‚’15ã€œ25å€‹æŠ½å‡ºã—ã€JSONé…åˆ—ã§å‡ºåŠ›ã€‚å„è¦ç´ ã¯{"term":"ç”¨èªå","def":"ç°¡æ½”ãªèª¬æ˜ï¼ˆ1ã€œ2æ–‡ï¼‰"}ã€‚æ—¥æœ¬èªã§ã€‚è‹±èªã®ç”¨èªã¯åŸèªã‚‚ä½µè¨˜ã€‚JSONã®ã¿å‡ºåŠ›ã€‚`,S.ruleText.slice(0,10000));
    if(r){const m=r.match(/\[[\s\S]*\]/);const items=m?JSON.parse(m[0]):[];
      $('glossaryContent').innerHTML=items.map(g=>`<div class="glossary-item"><div class="glossary-term">${esc(g.term)}</div><div class="glossary-def">${esc(g.def)}</div></div>`).join('')||'<div class="placeholder">ç”¨èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>'}
  }catch(e){$('glossaryContent').innerHTML=`<div class="placeholder">ã‚¨ãƒ©ãƒ¼: ${esc(e.message)}</div>`}
  $('glossaryBtn').disabled=false;$('glossaryBtn').textContent='ğŸ“– ç”¨èªã‚’æŠ½å‡º';
}

// === Flow Chart ===
async function generateFlow(){
  if(!S.claudeKey){switchTab('settings');return}
  $('flowBtn').disabled=true;$('flowBtn').textContent='â³ ç”Ÿæˆä¸­...';$('flowContent').innerHTML='<div style="color:var(--blue);font-size:12px"><div class="dot-anim"><span></span><span></span><span></span></div> ãƒ•ãƒ­ãƒ¼å›³ã‚’ç”Ÿæˆä¸­...</div>';
  try{
    const r=await callClaude(`ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«å°‚é–€å®¶ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ã‹ã‚‰ã‚¿ãƒ¼ãƒ³ã®æµã‚Œã‚’Mermaidè¨˜æ³•ã®ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã§ä½œæˆã€‚
ãƒ«ãƒ¼ãƒ«:
- graph TDå½¢å¼
- æ—¥æœ¬èªã®ãƒãƒ¼ãƒ‰å
- ã‚¿ãƒ¼ãƒ³é–‹å§‹â†’å„ãƒ•ã‚§ãƒ¼ã‚ºâ†’ã‚¿ãƒ¼ãƒ³çµ‚äº†ã®æµã‚Œ
- åˆ†å²ãŒã‚ã‚‹å ´åˆã¯æ¡ä»¶åˆ†å²ã‚’ä½¿ç”¨
- Mermaidã‚³ãƒ¼ãƒ‰ã®ã¿å‡ºåŠ›ï¼ˆ\`\`\`ã¯ä¸è¦ï¼‰`,S.ruleText.slice(0,8000));
    if(r){
      const mermaid=r.replace(/```mermaid|```/g,'').trim();
      $('flowContent').innerHTML=`<div class="flow-container"><pre style="font-size:12px;line-height:1.6;color:var(--text)">${esc(mermaid)}</pre></div><p style="font-size:11px;color:var(--text2);margin-top:8px">ğŸ’¡ ä¸Šã®Mermaidã‚³ãƒ¼ãƒ‰ã‚’ <a href="https://mermaid.live" target="_blank" style="color:var(--accent)">mermaid.live</a> ã«è²¼ã‚Šä»˜ã‘ã‚‹ã¨å›³ã¨ã—ã¦è¡¨ç¤ºã§ãã¾ã™</p>`}
  }catch(e){$('flowContent').innerHTML=`<div class="placeholder">ã‚¨ãƒ©ãƒ¼: ${esc(e.message)}</div>`}
  $('flowBtn').disabled=false;$('flowBtn').textContent='ğŸ”„ ãƒ•ãƒ­ãƒ¼å›³ã‚’ç”Ÿæˆ';
}

// === Scenario ===
function selectChip(btn,groupId){$(groupId).querySelectorAll('.scenario-chip').forEach(c=>c.classList.remove('active'));btn.classList.add('active')}
async function generateScenario(){
  if(!S.claudeKey){switchTab('settings');return}
  const players=$('scenarioPlayers').querySelector('.active')?.textContent||'2äºº';
  const level=$('scenarioLevel').querySelector('.active')?.textContent||'åˆãƒ—ãƒ¬ã‚¤';
  $('scenarioBtn').disabled=true;$('scenarioBtn').textContent='â³ ç”Ÿæˆä¸­...';$('scenarioContent').innerHTML='<div style="color:var(--blue);font-size:12px"><div class="dot-anim"><span></span><span></span><span></span></div> ã‚·ãƒŠãƒªã‚ªã‚’ç”Ÿæˆä¸­...</div>';
  try{
    const r=await callClaude(`ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«å°‚é–€å®¶ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ã«åŸºã¥ãã€ã€Œ${players}ãƒ»${level}ã€å‘ã‘ã®å…·ä½“çš„ãªãƒ—ãƒ¬ã‚¤ã‚·ãƒŠãƒªã‚ªã‚’æ—¥æœ¬èªã§ä½œæˆã€‚

å«ã‚ã‚‹å†…å®¹:
1. ğŸ¯ ã“ã®ã‚²ãƒ¼ãƒ ã®æ¦‚è¦ï¼ˆ2æ–‡ï¼‰
2. ğŸ“¦ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ï¼ˆã“ã®äººæ•°ãƒ»ãƒ¬ãƒ™ãƒ«å‘ã‘ã®å…·ä½“çš„ãªé…ç½®ï¼‰
3. ğŸ® æœ€åˆã®3ã‚¿ãƒ¼ãƒ³ã®æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
4. ğŸ’¡ ã“ã®äººæ•°ã§ã®ã‚³ãƒ„ãƒ»æ³¨æ„ç‚¹
5. â± æƒ³å®šãƒ—ãƒ¬ã‚¤æ™‚é–“

è‡ªç„¶ãªæ–‡ç« ã§ã€‚`,S.ruleText.slice(0,8000));
    if(r)$('scenarioContent').innerHTML=`<div class="card accent"><div class="card-body">${esc(r)}</div></div>`;
  }catch(e){$('scenarioContent').innerHTML=`<div class="placeholder">ã‚¨ãƒ©ãƒ¼: ${esc(e.message)}</div>`}
  $('scenarioBtn').disabled=false;$('scenarioBtn').textContent='ğŸ² ã‚·ãƒŠãƒªã‚ªç”Ÿæˆ';
}

// === QA ===
async function askQA(){const inp=$('qaInput'),msg=inp.value.trim();if(!msg)return;inp.value='';$('qaEmpty')?.remove();appendMsg('user',msg);$('qaSubmit').disabled=true;inp.disabled=true;const lid='ql-'+Date.now();appendMsg('assistant','<div class="dot-anim"><span></span><span></span><span></span></div>',lid);try{const a=await callClaude(`ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«å°‚é–€å®¶ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãæ—¥æœ¬èªã§å›ç­”ã€‚è¨˜è¼‰ãŒãªã‘ã‚Œã°ã€Œè¨˜è¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€ã€‚\n\nãƒ«ãƒ¼ãƒ«:\n${S.ruleText.slice(0,6000)}`,msg);$(lid).querySelector('.qa-msg-bubble').textContent=a||'å›ç­”ã§ãã¾ã›ã‚“ã§ã—ãŸ'}catch(e){$(lid).querySelector('.qa-msg-bubble').textContent='ã‚¨ãƒ©ãƒ¼: '+e.message};$('qaSubmit').disabled=false;inp.disabled=false;inp.focus()}
function appendMsg(r,h,id){const d=document.createElement('div');d.className='qa-msg '+r;if(id)d.id=id;d.innerHTML=`<div class="qa-msg-bubble">${h}</div>`;$('qaMessages').appendChild(d);d.scrollIntoView({behavior:'smooth'})}

init();
</script>
</body>
</html>
